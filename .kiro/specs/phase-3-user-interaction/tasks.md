# Phase 3: 用户交互 - 任务清单

## 任务概述

**执行周期：** Week 7-9 (3周)  
**团队配置：** 1个全栈开发 + 1个前端开发 + 1个UI/UX设计师  
**工作量估算：** 120-150 人时  

---

## 任务列表

- [ ] 1. 用户认证系统开发
  - 配置 NextAuth.js
  - 实现 Google OAuth 登录
  - 创建认证相关组件
  - _需求: Req 34_

- [ ] 1.1 安装和配置 NextAuth.js
  - 安装 `next-auth` 和相关依赖
  - 创建 `/api/auth/[...nextauth]/route.ts`
  - 配置 Google OAuth Provider
  - _需求: Req 34.1, Req 34.2_

- [ ] 1.2 扩展数据库 Schema
  - 添加 User、Account、Session 模型
  - 运行数据库迁移
  - _需求: Req 34.3_

- [ ] 1.3 创建登录组件
  - 创建 SignInButton 组件
  - 创建登录页面
  - 创建用户菜单
  - _需求: Req 34.4, Req 34.5_

- [ ] 1.4 实现会话管理
  - 配置 JWT token
  - 实现会话持久化
  - 实现退出登录功能
  - _需求: Req 34.6, Req 34.7_

- [ ] 1.5 测试认证流程
  - 测试 Google 登录
  - 测试会话保持
  - 测试退出登录
  - _需求: Req 34_

- [ ] 2. 评论系统开发
  - 扩展数据库 Schema
  - 创建评论 API
  - 创建评论组件
  - _需求: Req 15_

- [ ] 2.1 扩展数据库 Schema
  - 添加 Comment 模型（使用contentId关联到统一Content模型）
  - 添加 Like 模型（支持对Content和Comment点赞）
  - 更新 Content 模型添加 comments 和 likes 关联
  - 运行数据库迁移
  - 验证Comment可以关联到所有ContentType（ARTICLE、TIANJI_PAGE等）
  - _需求: Req 15, Phase 1 Req 48, Req 53_

- [ ] 2.2 创建评论 API
  - 实现 POST /api/comments（创建评论，使用contentId参数）
  - 实现 GET /api/comments（获取评论，支持按contentId查询）
  - 实现 PATCH /api/comments/[id]（审核评论）
  - 添加输入验证和错误处理（使用Zod验证contentId）
  - API响应包含关联的Content信息（type, slug, title）
  - _需求: Req 15.4, Req 15.7, Req 53_

- [ ] 2.3 创建 CommentSection 组件
  - 实现评论区布局
  - 集成评论表单
  - 集成评论列表
  - _需求: Req 15.1_

- [ ] 2.4 创建 CommentForm 组件
  - 实现评论输入框
  - 添加字符计数
  - 实现提交功能
  - _需求: Req 15.2, Req 15.3, Req 15.4_

- [ ] 2.5 创建 CommentItem 组件
  - 显示评论内容和用户信息
  - 实现回复功能
  - 实现点赞功能
  - 实现嵌套回复显示
  - _需求: Req 15.5, Req 15.6_

- [ ] 2.6 实现评论审核功能
  - 创建管理员审核页面
  - 实现审核 API
  - 添加审核状态显示
  - _需求: Req 15.7_

- [ ] 3. 点赞功能开发
  - 创建点赞 API
  - 实现点赞组件
  - 添加点赞动画
  - _需求: Req 15.6_

- [ ] 3.1 创建点赞 API
  - 实现 POST /api/likes（点赞/取消点赞）
  - 实现 GET /api/likes（获取点赞状态）
  - 添加防重复点赞逻辑
  - _需求: Req 15.6_

- [ ] 3.2 创建 LikeButton 组件
  - 实现点赞按钮
  - 显示点赞数量
  - 添加点赞动画
  - _需求: Req 15.6_

- [ ] 4. 社交分享功能开发
  - 创建分享组件
  - 实现各平台分享
  - 添加分享追踪
  - _需求: Req 16_

- [ ] 4.1 创建 ShareButtons 组件
  - 实现分享按钮布局
  - 添加平台图标
  - _需求: Req 16.1_

- [ ] 4.2 实现微信分享
  - 生成分享二维码
  - 创建二维码模态框
  - _需求: Req 16.2_

- [ ] 4.3 实现微博分享
  - 实现微博分享链接
  - 打开分享窗口
  - _需求: Req 16.3_

- [ ] 4.4 实现 Twitter 分享
  - 实现 Twitter 分享链接
  - 打开分享窗口
  - _需求: Req 16.4_

- [ ] 4.5 实现复制链接功能
  - 实现复制到剪贴板
  - 显示复制成功提示
  - _需求: Req 16.5_

- [ ] 4.6 添加分享追踪
  - 创建分享事件 API
  - 记录分享数据
  - 添加 UTM 参数
  - _需求: Req 16.6, Req 16.7_

- [ ] 5. 状态管理实现
  - 配置 Zustand
  - 配置 SWR
  - 创建全局 Store
  - _需求: Req 25_

- [ ] 5.1 安装和配置 Zustand
  - 安装 `zustand`
  - 创建用户 Store
  - 实现状态持久化
  - _需求: Req 25.1, Req 25.2_

- [ ] 5.2 配置 SWR
  - 安装 `swr`
  - 配置全局 SWR 设置
  - 创建自定义 fetcher
  - _需求: Req 25.4, Req 25.5_

- [ ] 5.3 实现数据获取 Hooks
  - 创建 useComments Hook
  - 创建 useUser Hook
  - 实现数据缓存和重新验证
  - _需求: Req 25.4, Req 25.5_

- [ ] 6. UI 组件库完善
  - 创建通用 UI 组件
  - 添加组件文档
  - 编写组件测试
  - _需求: Req 26_

- [ ] 6.1 创建 Modal 组件
  - 实现模态框布局
  - 添加打开/关闭动画
  - 支持键盘 ESC 关闭
  - _需求: Req 26.1, Req 26.3_

- [ ] 6.2 创建 Toast 组件
  - 实现 Toast 通知
  - 支持不同类型（成功、错误、警告）
  - 添加自动关闭
  - _需求: Req 26.3_

- [ ] 6.3 创建 Form 组件
  - 创建 Input 组件
  - 创建 Textarea 组件
  - 添加表单验证
  - _需求: Req 26.1, Req 26.2_

- [ ] 6.4 创建 Avatar 组件
  - 实现头像显示
  - 支持不同尺寸
  - 添加默认头像
  - _需求: Req 26.2_

- [ ] 7. API 集成优化
  - 创建统一的 API 客户端
  - 实现错误处理
  - 添加请求重试
  - _需求: Req 27_

- [ ] 7.1 创建 API 客户端
  - 实现 `lib/api-client.ts`
  - 添加请求拦截器
  - 添加响应拦截器
  - _需求: Req 27.1_

- [ ] 7.2 实现错误处理
  - 创建错误处理中间件
  - 显示友好的错误提示
  - 记录错误日志
  - _需求: Req 27.3_

- [ ] 7.3 实现请求重试
  - 添加自动重试逻辑
  - 配置重试次数和间隔
  - _需求: Req 27.2_

- [ ] 7.4 实现认证处理
  - 自动添加认证 token
  - 实现 token 刷新
  - 处理认证失败
  - _需求: Req 27.6, Req 27.7_

- [ ] 8. 类型定义完善
  - 定义所有数据模型类型
  - 定义 API 响应类型
  - 定义组件 Props 类型
  - _需求: Req 30_

- [ ] 8.1 定义用户相关类型
  - 定义 User 类型
  - 定义 Session 类型
  - 定义 AuthState 类型
  - _需求: Req 30.1, Req 30.2_

- [ ] 8.2 定义评论相关类型
  - 定义 Comment 类型
  - 定义 Like 类型
  - 定义 CommentStatus 枚举
  - _需求: Req 30.1, Req 30.2_

- [ ] 8.3 定义 API 类型
  - 定义 API 请求类型
  - 定义 API 响应类型
  - 定义错误类型
  - _需求: Req 30.2, Req 30.3_

- [ ] 9. 转化优化实施
  - 优化 CTA 按钮
  - 添加引导提示
  - 实现转化追踪
  - _需求: Req 43_

- [ ] 9.1 优化 CTA 按钮
  - 优化按钮文案
  - 优化按钮位置
  - 添加按钮动画
  - _需求: Req 43.3_

- [ ] 9.2 添加引导提示
  - 创建新用户引导
  - 添加功能提示
  - 实现提示关闭
  - _需求: Req 43.4_

- [ ] 9.3 实现转化追踪
  - 记录用户来源
  - 实现 Last-Click 归因
  - 创建转化漏斗报告
  - _需求: Req 43.1, Req 43.2, Req 43.6_

- [ ] 10. 多语言用户交互支持
  - 创建用户交互翻译资源
  - 更新组件支持多语言
  - 测试多语言功能
  - _需求: Req 52, Phase 1 Req 49_

- [ ] 10.1 创建多语言翻译资源
  - 创建 public/locales/*/user-interaction.json 文件
  - 添加认证相关翻译（zh-CN, zh-TW, en）
  - 添加评论相关翻译（zh-CN, zh-TW, en）
  - 添加分享相关翻译（zh-CN, zh-TW, en）
  - 添加错误提示翻译（zh-CN, zh-TW, en）
  - _需求: Req 52_

- [ ] 10.2 更新认证组件支持多语言
  - 在 SignInButton 组件中集成 useTranslation
  - 使用翻译key替换硬编码文本
  - 测试不同locale下的显示
  - _需求: Req 52.1, Req 52.2_

- [ ] 10.3 更新评论组件支持多语言
  - 在 CommentSection、CommentForm、CommentItem 中集成 useTranslation
  - 使用翻译key替换硬编码文本
  - 确保评论内容本身不被翻译
  - 测试不同locale下的显示
  - _需求: Req 52.3_

- [ ] 10.4 更新分享组件支持多语言
  - 在 ShareButtons 组件中集成 useTranslation
  - 实现多语言分享文案生成函数
  - 根据locale生成不同的分享文本
  - _需求: Req 52.4_

- [ ] 10.5 更新错误提示支持多语言
  - 更新 API 错误处理返回翻译key
  - 在前端显示多语言错误信息
  - 更新表单验证错误提示
  - _需求: Req 52.5, Req 52.6_

- [ ] 11. 测试和验证
  - 进行功能测试
  - 进行集成测试
  - 进行用户测试
  - 进行多语言测试
  - _需求: 所有需求_

- [ ] 11.1 功能测试
  - 测试登录流程
  - 测试评论功能（所有ContentType）
  - 测试点赞功能
  - 测试分享功能
  - _需求: 所有需求_

- [ ] 11.2 集成测试
  - 测试认证和评论集成
  - 测试评论与Content模型集成
  - 测试状态管理
  - 测试 API 调用
  - _需求: Req 25, Req 27, Req 53_

- [ ] 11.3 多语言功能测试
  - 测试不同locale下的用户交互界面
  - 测试语言切换功能
  - 测试多语言分享文案
  - 测试多语言错误提示
  - _需求: Req 52_

- [ ] 11.4 用户测试
  - 邀请用户测试
  - 收集用户反馈
  - 修复发现的问题
  - _需求: 所有需求_

- [ ] 12. 文档和交付
  - 编写用户指南
  - 编写开发文档
  - 准备演示
  - _需求: 所有需求_

- [ ] 12.1 编写用户指南
  - 编写登录指南（多语言）
  - 编写评论指南（多语言）
  - 编写分享指南（多语言）
  - _需求: 所有需求, Req 52_

- [ ] 12.2 编写开发文档
  - 文档化 API 端点（包含contentId使用说明）
  - 文档化组件使用（包含多语言组件使用）
  - 文档化状态管理
  - 文档化Comment与Content模型集成
  - _需求: 所有需求, Req 53_

---

## 验收检查清单

### 认证功能
- [ ] Google 登录正常工作
- [ ] 会话保持正常
- [ ] 退出登录正常
- [ ] 用户信息正确显示

### 评论功能
- [ ] 可以对所有类型的Content发表评论（文章、天纪、地纪、人纪页面）
- [ ] 可以回复评论
- [ ] 可以点赞评论
- [ ] 评论审核正常工作
- [ ] 嵌套回复正确显示
- [ ] 评论与Content模型正确关联（通过contentId）
- [ ] API返回包含Content类型和slug信息

### 分享功能
- [ ] 微信分享正常
- [ ] 微博分享正常
- [ ] Twitter 分享正常
- [ ] 复制链接正常
- [ ] 分享追踪正常

### 状态管理
- [ ] 全局状态正常工作
- [ ] 数据缓存正常
- [ ] 数据重新验证正常

### UI 组件
- [ ] 所有组件样式一致
- [ ] 所有组件交互正常
- [ ] 所有组件响应式

### 多语言功能
- [ ] 认证界面支持多语言（zh-CN, zh-TW, en）
- [ ] 评论界面支持多语言
- [ ] 分享界面支持多语言
- [ ] 错误提示支持多语言
- [ ] 语言切换后界面正确更新
- [ ] 所有交互文本都有翻译

---

**文档版本：** 1.1.0
**创建日期：** 2024-11-07
**最后更新：** 2025-01-07
**文档状态：** ✅ 已完成
**更新说明：**
- 更新评论和点赞功能使用统一Content模型（contentId替代articleId）
- 添加多语言用户交互支持任务（Task 10）
- 更新测试任务以包含多语言和Content模型集成测试
- 更新验收清单以包含多语言功能验证
